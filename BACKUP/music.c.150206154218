#include<iom16v.h>
#include<macros.h>
//计时值=65536-系统时钟/分频系数/音调频率/2   
//      音符 计时值  频率Hz 
#define LL6	 62414   //220	
#define LL7  62662   //247   	
#define L1	 62678   //262    
#define L2	 63186   //294	
#define L3	 63171   //330   	
#define L4	 63254   //349	
#define L5	 63411   //392	
#define L6	 64450   //440	
#define L7	 63674   //494	
#define N1	 63729   //523	
#define N2	 63835   //587	
#define N3	 63928   //659	
#define N4	 63970   //698	
#define N5	 64049   //784	
#define N6	 64118   //880	
#define N7	 64180   //988	
#define H1	 64209   //1047	 
#define H2	 64261   //1175	
#define H3	 64407   //1319
	
#define H4	 64329   //1397	
#define H5	 64368   //1568	
#define H6	 64402   //1760	
#define H7	 64433   //1976	
#define HH1	 64448   //2093
#define O    0       //休止符

/************************************
音乐数据
这段是《孤星独吟》，自己对着简谱翻的
*************************************/
unsigned int song[]=
{
 N6,12,N7,4,H1,8,H2,4,H3,4,/**/H2,32,/**/N7,12,N6,4,N5,8,N3,4,N5,4,/**/
 N6,32,/**/H1,12,N6,4,N6,8,H3,8,/**/H2,32,/**/N5,22,N6,4,N7,8,H1,4,N7,4,/**/
 N6,32, /**/H3,24,N6,8,/**/H2,24,H3,4,H2,4,/**/H1,16,H1,4,N6,4,H1,4,H2,4,/**/
 N7,24,H1,4,H2,4,/**/H3,24,H2,4,H1,4,/**/H2,32,/**/
 N5,4,N6,4,N7,16,N7,4,N5,4,/**/N6,32,/**/
 N6,12,N7,4,H1,8,H2,4,H3,4,/**/H2,32,/**/N7,12,N6,4,N5,8,N3,4,N5,4,/**/
 N6,32,/**/H1,12,N6,4,N6,8,H3,8,/**/H2,32,/**/N5,12,N6,4,N7,8,H1,4,N7,4,/**/
 N6,32,/**/H3,24,N6,8,/**/H2,24,H3,4,H2,4,/**/H1,16,H1,4,N6,4,H1,4,H2,4,/**/
 N7,24,H1,4,H2,4,/**/H3,24,H2,4,H1,4,/**/H2,32,/**/
 N5,4,N6,4,N7,16,N6,4,N5,4,/**/N6,32,/**/H3,24,H2,4,H1,4,/**/H2,32,/**/
 H1,24,N7,4,N6,4,/**/N7,24,H1,4,H2,4,/**/H3,24,H3,4,N6,4,/**/H2,24,H3,4,H2,4, /**/
 H1,16,H1,4,N6,4,H1,4,H2,4,/**/N7,32,/**/H3,24,N6,8,/**/H2,24,H3,4,H2,4,/**/
 H1,16,H1,4,N6,4,H1,4,H2,4,/**/N7,24,H1,4,H2,4,/**/H3,24,H2,4,H1,4,/**/
 H2,24,H3,4,H2,4,/**/H1,24,N6,8,/**/N7,24,H1,8,/**/N6,32,/**/N6,32,/**/
 0xFF //音乐结尾符
};

unsigned int beat;    //beat用以存储音符对应的计数值


/****************************
函数功能：控制整首乐曲的演奏
*****************************/
void Music(unsigned int *pMusic) 
{ 
  while(*pMusic!=0xFF) 			//0xFF为音乐结尾符 
    { 
      TIMSK=0x04;				//Timer1溢出中断使能      
	  beat=*pMusic;             //取出音符
	  TCNT1H=beat/256;			 
	  TCNT1L=beat%256;          //将音符对应的计数值写入计时器,开始发声
                
      pMusic++;					//乐谱音符指针+1 ,取拍数
      delay_ms((*pMusic)*60);   //节拍延时，可以通过这里调整音乐播放速度

      TIMSK=0x00;			   	//当前音符结束,屏蔽Timer1溢出中断
                
      pMusic++;					//乐谱音符指针+1，指向下一音符
    } 
    delay_ms(1000);    			//曲谱结束,等待              
}

/************************************
函数功能：完成单个音符的播放
*************************************/
#pragma interrupt_handler timer1_ovf_isr:iv_TIM1_OVF
void timer1_ovf_isr(void)
{
 if(beat)
 {
  PORTA ^= BIT(1);     //蜂鸣器接入口电平翻转
  TCNT1H=beat/256;			
  TCNT1L=beat%256;     //将音符对应的计数值写入计时器
 }
}

void bell(select)
{
	
 	 DDRA|=(1<<PA1);     //设置PORTA为输出
	 PORTA&=~(1<<PA1);     
 
 	 TCCR1B = 0x01;     //Timer1开始工作，不分频，分频系数为1
 	 SEI();             //打开全局中断
 
 	do
	{
		Music(song);
	}
	while(select!='*');
 
}